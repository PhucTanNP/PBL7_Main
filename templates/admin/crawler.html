{% extends "layouts/base.html" %}
{% block title %}Crawler công việc{% endblock %}

{% block content %}
<div class="pc-container">
  <div class="pc-content">

    <h2 class="mb-4 text-primary fw-bold d-flex align-items-center">
      <i data-feather="download" class="me-2 text-primary"></i> Crawl công việc từ TopCV
    </h2>

    <!-- Nút crawl -->
    <form method="POST" action="{{ url_for('admin_blueprint.do_crawl') }}" id="crawlForm">
      <button class="btn btn-success mb-3" type="submit" id="crawlBtn">
        <i data-feather="cloud-download" class="me-1"></i> Bắt đầu Crawl
      </button>
    </form>

    <!-- Spinner đang tải -->
    <div id="loadingSpinner" class="text-center d-none mb-3">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2 fw-semibold text-primary">Đang thu thập dữ liệu...</p>
    </div>

    <!-- Bảng kết quả -->
    <form method="POST" action="{{ url_for('admin_blueprint.save_crawled_data') }}">
      <div class="table-responsive border rounded shadow-sm">
        <table class="table table-striped align-middle table-sm mb-0">
          <thead class="table-primary text-center">
            <tr>
              <th>#</th>
              <th>Tiêu đề</th>
              <th>Công ty</th>
              <th>Ngành nghề</th>
              <th>Địa điểm</th>
              <th>Mức lương</th>
              <th>Kinh nghiệm</th>
              <th>Ngày đăng</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody>
            {% if crawled_jobs %}
              {% for job in crawled_jobs %}
              <tr>
                <td>{{ loop.index }}</td>
                <td><input name="job_title_{{ loop.index0 }}" class="form-control" value="{{ job.job_title }}" readonly></td>
                <td><input name="company_name_{{ loop.index0 }}" class="form-control" value="{{ job.company_name }}" readonly></td>
                <td><input name="industry_{{ loop.index0 }}" class="form-control" value="{{ job.industry }}" readonly></td>
                <td><input name="location_{{ loop.index0 }}" class="form-control" value="{{ job.location }}" readonly></td>
                <td><input name="salary_{{ loop.index0 }}" class="form-control" value="{{ job.salary }}" readonly></td>
                <td><input name="experience_{{ loop.index0 }}" class="form-control" value="{{ job.experience }}" readonly></td>
                <td><input name="create_at_{{ loop.index0 }}" class="form-control" value="{{ job.create_at }}" readonly></td>
                <td class="text-center">
                  <div class="d-flex justify-content-center gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm d-flex align-items-center" onclick="enableEdit(this)">
                      <i data-feather="edit-2" class="me-1"></i> Chỉnh sửa
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm d-flex align-items-center" onclick="deleteRow(this)">
                      <i data-feather="trash-2" class="me-1"></i> Xoá
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="10" class="text-center text-muted">Chưa có dữ liệu. Hãy nhấn "Bắt đầu Crawl".</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      {% if crawled_jobs %}
        <input type="hidden" name="job_count" value="{{ crawled_jobs|length }}">
        <button class="btn btn-primary mt-3"><i data-feather="save" class="me-1"></i> Lưu dữ liệu</button>
      {% endif %}
    </form>
  </div>
</div>

<script>
  feather.replace();

  document.getElementById('crawlForm')?.addEventListener('submit', function () {
    document.getElementById('crawlBtn').classList.add('d-none');
    document.getElementById('loadingSpinner').classList.remove('d-none');
  });

  function enableEdit(button) {
    const row = button.closest('tr');
    const inputs = row.querySelectorAll('input');

    const isEditing = button.classList.contains('btn-outline-success');
    if (!isEditing) {
      inputs.forEach(input => input.removeAttribute('readonly'));
      button.classList.remove('btn-outline-secondary');
      button.classList.add('btn-outline-success');
      button.innerHTML = '<i data-feather="check" class="me-1"></i> Lưu';
    } else {
      inputs.forEach(input => input.setAttribute('readonly', true));
      button.classList.remove('btn-outline-success');
      button.classList.add('btn-outline-secondary');
      button.innerHTML = '<i data-feather="edit-2" class="me-1"></i> Chỉnh sửa';
    }
    feather.replace();
  }

  function deleteRow(button) {
    const row = button.closest('tr');
    row.remove();
  }
</script>
{% endblock %}
